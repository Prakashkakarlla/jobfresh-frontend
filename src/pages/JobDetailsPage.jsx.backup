import { useState, useEffect } from 'react'
import { useParams, useNavigate } from 'react-router-dom'
import axios from 'axios'

function JobDetailsPage() {
    const { slug } = useParams()
    const navigate = useNavigate()
    const [job, setJob] = useState(null)
    const [company, setCompany] = useState(null)
    const [category, setCategory] = useState(null)
    const [relatedJobs, setRelatedJobs] = useState([])
    const [loading, setLoading] = useState(true)

    useEffect(() => {
        fetchJobDetails()
    }, [slug])

    const fetchJobDetails = async () => {
        try {
            const response = await axios.get(`/api/jobs/${slug}`)
            setJob(response.data)
            setLoading(false)

            console.log('Job data:', response.data)

            // Detail API returns company and category as objects with slug field
            const companySlug = response.data.company?.slug
            const categorySlug = response.data.category?.slug

            console.log('Company slug:', companySlug, 'Category slug:', categorySlug)

            // Fetch full company and category details
            if (companySlug) {
                fetchCompanyDetails(companySlug)
            }
            if (categorySlug) {
                fetchCategoryDetails(categorySlug)
            }

            // Fetch related jobs
            if (categorySlug || response.data.companyName) {
                fetchRelatedJobs(response.data.id, categorySlug, response.data.companyName)
            }
        } catch (error) {
            console.error('Error fetching job details:', error)
            setLoading(false)
        }
    }

    const fetchCompanyDetails = async (companySlug) => {
        try {
            const response = await axios.get('/api/companies/all')
            const foundCompany = response.data.find(c => c.slug === companySlug)
            if (foundCompany) {
                console.log('Found company:', foundCompany)
                setCompany(foundCompany)
            } else {
                console.log('Company not found for slug:', companySlug)
            }
        } catch (error) {
            console.error('Error fetching company details:', error)
        }
    }

    const fetchCategoryDetails = async (categorySlug) => {
        try {
            const response = await axios.get('/api/categories/all')
            const foundCategory = response.data.find(c => c.slug === categorySlug)
            if (foundCategory) {
                console.log('Found category:', foundCategory)
                setCategory(foundCategory)
            } else {
                console.log('Category not found for slug:', categorySlug)
            }
        } catch (error) {
            console.error('Error fetching category details:', error)
        }
    }

    const fetchRelatedJobs = async (currentJobId, categorySlug, companyName) => {
        try {
            const response = await axios.get('/api/jobs?size=20')
            const allJobs = response.data.content

            // Filter to get related jobs (same category or same company, exclude current job)
            const related = allJobs
                .filter(j => j.id !== currentJobId) // Exclude current job
                .filter(j => j.categorySlug === categorySlug || j.companyName === companyName) // Same category or company
                .slice(0, 4) // Limit to 4 related jobs

            setRelatedJobs(related)
        } catch (error) {
            console.error('Error fetching related jobs:', error)
        }
    }

    const formatSalary = (min, max) => {
        const formatLPA = (amount) => {
            return `‚Çπ${(amount / 100000).toFixed(0)} LPA`
        }
        return `${formatLPA(min)} - ${formatLPA(max)}`
    }

    const handleApply = () => {
        if (job.applicationLink) {
            window.open(job.applicationLink, '_blank')
        }
    }

    if (loading) {
        return <div className="loading">Loading job details...</div>
    }

    if (!job) {
        return (
            <div className="container" style={{ padding: '4rem 0', textAlign: 'center' }}>
                <h2>Job not found</h2>
                <button className="btn btn-primary" onClick={() => navigate('/')}>
                    Back to Jobs
                </button>
            </div>
        )
    }

    return (
        <div className="job-details">
            <div className="container">
                <button
                    onClick={() => navigate('/')}
                    style={{
                        background: 'none',
                        border: 'none',
                        color: 'var(--primary)',
                        cursor: 'pointer',
                        fontSize: '1rem',
                        marginBottom: '1.5rem',
                        padding: '0.5rem 0'
                    }}
                >
                    ‚Üê Back to all jobs
                </button>

                {/* Two-column layout: Main content + Sidebar */}
                <div style={{
                    display: 'grid',
                    gridTemplateColumns: relatedJobs.length > 0 ? '1fr 350px' : '1fr',
                    gap: '2rem',
                    '@media (max-width: 968px)': {
                        gridTemplateColumns: '1fr'
                    }
                }}>
                    {/* Main content */}
                    <div className="job-details-card fade-in">
                        <div style={{ marginBottom: '2rem' }}>
                            <h1>{job.title}</h1>

                            {/* Company info with logo */}
                            <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: '1rem' }}>
                                {company?.logoUrl && (
                                    <img
                                        src={company.logoUrl}
                                        alt={job.companyName}
                                        style={{ width: '60px', height: '60px', objectFit: 'contain', borderRadius: '8px', border: '1px solid #e5e7eb' }}
                                    />
                                )}
                                <p style={{ fontSize: '1.25rem', color: 'var(--text-secondary)', margin: 0 }}>
                                    {job.companyName}
                                </p>
                            </div>

                            <div className="job-meta" style={{ marginBottom: '1.5rem' }}>
                                <span className="meta-item">üìç {job.location}</span>
                                <span className="meta-item">üíº {job.jobType}</span>
                                <span className="meta-item">üè¢ {job.workMode}</span>
                                {job.remote && <span className="badge badge-success">Remote Available</span>}
                            </div>

                            {/* Salary from compensation object or direct fields */}
                            {(job.compensation?.salaryMin || job.salaryMin) && (
                                <div className="salary" style={{ fontSize: '1.5rem', marginBottom: '1.5rem', fontWeight: '600', color: 'var(--primary)' }}>
                                    üí∞ {formatSalary(
                                        job.compensation?.salaryMin || job.salaryMin,
                                        job.compensation?.salaryMax || job.salaryMax
                                    )}
                                </div>
                            )}

                            <button
                                className="btn btn-primary"
                                onClick={handleApply}
                                style={{ fontSize: '1.125rem', padding: '1rem 2.5rem' }}
                            >
                                Apply Now
                            </button>
                        </div>

                        {/* Company Information Section */}
                        {company && company.about && (
                            <div className="job-section" style={{ background: '#f8fafc', padding: '1.5rem', borderRadius: '8px', border: '1px solid #e2e8f0' }}>
                                <h2>About {company.name}</h2>
                                <p>{company.about}</p>
                                {company.website && (
                                    <p style={{ marginTop: '1rem' }}>
                                        <strong>Website:</strong>{' '}
                                        <a href={company.website} target="_blank" rel="noopener noreferrer" style={{ color: 'var(--primary)' }}>
                                            {company.website}
                                        </a>
                                    </p>
                                )}
                            </div>
                        )}

                        {/* Category Information Section */}
                        {category && (
                            <>
                                {category.introText && (
                                    <div className="job-section">
                                        <h2>About {category.name} Jobs</h2>
                                        <p>{category.introText}</p>
                                    </div>
                                )}

                                {category.careerGuide && (
                                    <div className="job-section">
                                        <h2>Career Guide: {category.name}</h2>
                                        <p style={{ whiteSpace: 'pre-line' }}>{category.careerGuide}</p>
                                    </div>
                                )}

                                {category.faq && (
                                    <div className="job-section">
                                        <h2>Frequently Asked Questions</h2>
                                        <p style={{ whiteSpace: 'pre-line' }}>{category.faq}</p>
                                    </div>
                                )}
                            </>
                        )}

                        {job.roleSummary && (
                            <div className="job-section">
                                <h2>About the Role</h2>
                                <p>{job.roleSummary}</p>
                            </div>
                        )}

                        {job.responsibilities && (
                            <div className="job-section">
                                <h2>Responsibilities</h2>
                                <ul>
                                    {job.responsibilities.split('\n').map((resp, index) => (
                                        <li key={index}>{resp}</li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {job.mustHaveSkills && (
                            <div className="job-section">
                                <h2>Required Skills</h2>
                                <p>{job.mustHaveSkills}</p>
                            </div>
                        )}

                        {job.niceToHaveSkills && (
                            <div className="job-section">
                                <h2>Nice to Have</h2>
                                <p>{job.niceToHaveSkills}</p>
                            </div>
                        )}

                        {job.benefitsSummary && (
                            <div className="job-section">
                                <h2>Benefits</h2>
                                <p>{job.benefitsSummary}</p>
                            </div>
                        )}

                        {(job.eligibleBatch || job.qualification || job.experienceLevel || job.lastDateToApply) && (
                            <div className="job-section">
                                <h2>Eligibility Information</h2>
                                {job.eligibleBatch && <p><strong>Eligible Batch:</strong> {job.eligibleBatch}</p>}
                                {job.qualification && <p><strong>Qualification:</strong> {job.qualification}</p>}
                                {job.experienceLevel && <p><strong>Experience:</strong> {job.experienceLevel}</p>}
                                {job.lastDateToApply && <p><strong>Last Date to Apply:</strong> {new Date(job.lastDateToApply).toLocaleDateString()}</p>}
                            </div>
                        )}

                        {job.eligibilityCriteria && (
                            <div className="job-section">
                                <h2>Eligibility Criteria</h2>
                                <ul>
                                    {job.eligibilityCriteria.split('\n').filter(c => c.trim()).map((criteria, index) => (
                                        <li key={index}>{criteria}</li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {job.selectionProcess && (
                            <div className="job-section">
                                <h2>Selection Process</h2>
                                <ul>
                                    {job.selectionProcess.split('\n').filter(s => s.trim()).map((stage, index) => (
                                        <li key={index}>{stage}</li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {job.interviewTips && (
                            <div className="job-section">
                                <h2>Interview Tips</h2>
                                <ul>
                                    {job.interviewTips.split('\n').filter(t => t.trim()).map((tip, index) => (
                                        <li key={index}>{tip}</li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {job.careerGrowthInfo && (
                            <div className="job-section">
                                <h2>Career Growth</h2>
                                <p>{job.careerGrowthInfo}</p>
                                {job.futureRoles && (
                                    <p style={{ marginTop: '1rem' }}>
                                        <strong>Possible Future Roles:</strong> {job.futureRoles}
                                    </p>
                                )}
                            </div>
                        )}

                        <div className="job-section">
                            <h2>How to Apply</h2>
                            <p>Click the "Apply Now" button above to be redirected to the company's application page.</p>
                            <button
                                className="btn btn-primary"
                                onClick={handleApply}
                                style={{ marginTop: '1rem' }}
                            >
                                Apply for this position
                            </button>
                        </div>

                        {/* Related Jobs Section */}
                        {relatedJobs.length > 0 && (
                            <div style={{ marginTop: '3rem', paddingTop: '2rem', borderTop: '2px solid #e5e7eb' }}>
                                <h2 style={{ marginBottom: '1.5rem' }}>Related Job Opportunities</h2>
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))',
                                    gap: '1.5rem'
                                }}>
                                    {relatedJobs.map(relatedJob => (
                                        <div
                                            key={relatedJob.id}
                                            className="job-card"
                                            onClick={() => navigate(`/jobs/${relatedJob.slug}`)}
                                            style={{
                                                padding: '1.5rem',
                                                border: '1px solid #e5e7eb',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                transition: 'all 0.2s',
                                                background: 'white'
                                            }}
                                            onMouseEnter={(e) => {
                                                e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)'
                                                e.currentTarget.style.transform = 'translateY(-2px)'
                                            }}
                                            onMouseLeave={(e) => {
                                                e.currentTarget.style.boxShadow = 'none'
                                                e.currentTarget.style.transform = 'translateY(0)'
                                            }}
                                        >
                                            <h3 style={{ fontSize: '1.1rem', marginBottom: '0.5rem', color: 'var(--text)' }}>
                                                {relatedJob.title}
                                            </h3>
                                            <p style={{ color: 'var(--text-secondary)', marginBottom: '0.75rem' }}>
                                                {relatedJob.companyName}
                                            </p>
                                            <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap', fontSize: '0.85rem', color: 'var(--text-secondary)' }}>
                                                <span>üìç {relatedJob.location}</span>
                                                <span>üíº {relatedJob.jobType}</span>
                                            </div>
                                            <div style={{ marginTop: '0.75rem' }}>
                                                <span className="badge badge-primary" style={{ fontSize: '0.75rem' }}>
                                                    {relatedJob.categoryName}
                                                </span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            </div>
            )
}

            export default JobDetailsPage
